trigger:
  branches:
    include:
      - main
      - dev
      - feature/*

pool:
  vmImage: ubuntu-latest

stages:
  - stage: DeployToDev
    displayName: 'Deploy to Dev Environment'
    condition: or(eq(variables['Build.SourceBranchName'], 'dev'), startsWith(variables['Build.SourceBranchName'], 'feature/'))
    variables:
      - group: SF-Dev-Variables
    jobs:
      - job: DeployDev
        displayName: 'Deploy to Salesforce Dev'
        steps:
          - checkout: self

          - task: DownloadSecureFile@1
            name: GetJWTKey
            inputs:
              secureFile: 'server.key'

          - task: NodeTool@0
            inputs:
              versionSpec: '18.x'
              checkLatest: true

          - script: |
              npm install -g sfdx-cli
              echo "Installing PMD"
              npm install -g pmd-bin
            displayName: 'Install Salesforce CLI and PMD'

          - script: |
              sfdx auth:jwt:grant \
                --clientid $(SF_CLIENT_ID) \
                --jwtkeyfile $(GetJWTKey.secureFilePath) \
                --username $(SF_USERNAME) \
                --instanceurl $(SF_INSTANCE_URL)
            displayName: 'Authenticate to Salesforce (Dev)'

          - script: |
              echo "Running PMD Code Analysis"
              pmd-bin run pmd \
                -d force-app \
                -R category/apex/design.xml \
                -f text
            displayName: 'Run PMD Static Code Analysis'

          - script: |
              echo "Running Tests & Deploying Code"
              sfdx force:source:deploy \
                --sourcepath force-app \
                --targetusername $(SF_USERNAME) \
                --ignorewarnings \
                --wait 10 \
                --testlevel RunLocalTests
            displayName: 'Deploy Source to Dev Org with Tests'

  - stage: DeployToProd
    displayName: 'Deploy to Production Environment'
    condition: eq(variables['Build.SourceBranchName'], 'main')
    variables:
      - group: SF-Prod-Variables
    jobs:
      - deployment: DeployProd
        displayName: 'Production Deployment'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: DownloadSecureFile@1
                  name: GetJWTKey
                  inputs:
                    secureFile: 'server.key'

                - task: NodeTool@0
                  inputs:
                    versionSpec: '18.x'
                    checkLatest: true

                - script: |
                    npm install -g sfdx-cli
                  displayName: 'Install Salesforce CLI'

                - script: |
                    sfdx auth:jwt:grant \
                      --clientid $(SF_CLIENT_ID) \
                      --jwtkeyfile $(GetJWTKey.secureFilePath) \
                      --username $(SF_USERNAME) \
                      --instanceurl $(SF_INSTANCE_URL)
                  displayName: 'Authenticate to Salesforce (Prod)'

                - script: |
                    sfdx force:source:deploy \
                      --sourcepath force-app \
                      --targetusername $(SF_USERNAME) \
                      --ignorewarnings \
                      --wait 10 \
                      --testlevel RunLocalTests
                  displayName: 'Deploy Source to Production Org with Tests'
